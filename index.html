<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@8.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

    <link href="https://unpkg.com/jspsych@8.0.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

  <body></body>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Initialize jsPsych
      const jsPsych = initJsPsych();

      // Generate unique subject ID and assign a condition
      const subject_id = jsPsych.randomization.randomID(10);
      const condition = Math.random() < 0.5 ? "moral" : "immoral";

      // Initialize responseData object
      const responseData = {
        subject_id: subject_id,
        condition: condition,
        character_order: "", // Set based on randomized order
        justin: {}, // Justin's responses
        nate: {}    // Nate's responses
      };

      // Consent page
      const consent = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div><h2>Consent Form</h2><p>Consent information here...</p><p>Press any key to confirm consent and continue.</p></div>`
      };

      // Instructions page
      const instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div><h3>Experiment Instructions</h3><p>Instructions go here.</p><p>Press any key to continue to the scenarios.</p></div>`
      };

      // Trial (scenario) based on condition
      const trial_scenario = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div><p>Scenario based on ${condition} condition...</p><p>Press any key to continue.</p></div>`
      };

      // Function to create a questionnaire for a person
      function createQuestionnaire(name) {
        const labels = ["1", "2", "3", "4", "5", "6", "7"];
        const questions = [
          { prompt: `Did ${name} make his decision quickly or slowly? (1 = particularly slowly, 7 = particularly quickly)`, labels, required: true },
          { prompt: `Regardless of ${name}'s decision, does it sound like ${name} has underlying moral principles that are good, bad, or somewhere in between? (1 = completely bad, 4 = mixed, 7 = completely good)`, labels, required: true },
          { prompt: `Regardless of ${name}'s decision, do you think ${name} has moral standards that are good, bad, or somewhere in between? (1 = completely bad, 4 = mixed, 7 = completely good)`, labels, required: true },
          { prompt: `Regardless of ${name}'s decision, do you think ${name} possesses the moral knowledge and principles necessary to do 'the right thing'? (1 = not at all, 4 = somewhat, 7 = completely)`, labels, required: true },
          { prompt: `Would you say ${name} was quite certain in his decision, or did ${name} have hesitations about his decision? (1 = completely certain, 7 = considerable hesitations)`, labels, required: true },
          { prompt: `How close do you think ${name} was to choosing the alternate course of action? (1 = very close to, 7 = not close at all)`, labels, required: true },
          { prompt: `How conflicted do you think ${name} felt in making the decision? (1 = very conflicted, 7 = not at all conflicted)`, labels, required: true },
          { prompt: `Based on the information provided, do you think ${name} had many reservations about the decision? (1 = none at all, 7 = a whole lot)`, labels, required: true },
          { prompt: `Do you think ${name} was calm and emotionally contained while making the decision? (1 = not at all, 7 = entirely so)`, labels, required: true },
          { prompt: `To what extent do you think ${name} became upset and acted without thinking? (1 = not at all, 7 = entirely so)`, labels, required: true }
        ];

        return {
          type: jsPsychSurveyLikert,
          questions: questions,
          preamble: `<p>${name} was faced with a moral decision...</p>`,
          on_finish: (data) => {
            responseData[name.toLowerCase()] = data.response; // Store responses in responseData
          }
        };
      }

      // Create Justin's and Nate's questionnaires and randomize order
      const justin_questions = createQuestionnaire("Justin");
      const nate_questions = createQuestionnaire("Nate");
      const randomized_questions = jsPsych.randomization.shuffle([justin_questions, nate_questions]);

      // Set character order in responseData based on the randomized order
      responseData.character_order = randomized_questions[0] === justin_questions ? "justin_first" : "nate_first";

      // End message
      const end_message = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Thank you for participating!</p><p>Press any key to finish.</p>"
      };

      // Save data configuration
      const filename = `${subject_id}.json`;
      const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "fWVZFOaYbb59", // Replace with your actual experiment ID
        filename: filename,
        data_string: () => jsPsych.data.get().csv()
      };

      // Experiment timeline
      const timeline = [consent, instructions, trial_scenario, ...randomized_questions, end_message, save_data];

      // Run the experiment
      jsPsych.run(timeline);
    });
  </script>
</html>
