<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/jspsych@8.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>

    <link href="https://unpkg.com/jspsych@8.0.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="style.css" rel="stylesheet" type="text/css" />
  </head>

  <body></body>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Initialize jsPsych
      const jsPsych = initJsPsych();

      // Randomly assign participant to a condition and log it
      const condition = Math.random() < 0.5 ? "moral" : "immoral";
      console.log("Assigned condition:", condition);

      // Consent page
      const consent = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div id='welcome_pg' class='welcome'>
            <p style="font-size: 24pt;"><strong>Welcome to the study!</strong></p>
            <p>Press any key to confirm consent and continue.</p>
          </div>
        `,
        on_finish: () => console.log("Consent page completed")
      };

      // Instructions page
      const instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div id='instruction_pg' class='instruction'>
            <p style="font-size: 24pt"><strong>Experiment Instructions</strong></p>
            <p>In this study, you will read scenarios and answer questions about moral decisions.</p>
            <p>Press any key to continue to the scenarios.</p>
          </div>
        `,
        on_finish: () => console.log("Instructions page completed")
      };

      // Trial (scenario) based on condition
      const trial_scenario = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
          <div id='trial'>
            <p style="font-size: 17pt"><strong>Please read the following scenario carefully.</strong></p>

            <div id='general' class='scenario'>
              <p>Justin and Nate were walking to separate cars in the parking lot of Andronico's, a local grocery store, when they each spotted a different lost wallet next to their cars. Upon picking up the wallet and looking inside, each found several hundred dollars in cash. Each man considered whether he should return the wallet and money to the Customer Service desk at Andronico's or pocket the money and drive away.</p>
            </div>
            ${
              condition === "moral"
                ? `<div id='moral_trial'>
                    <div id='m_justin' class='moral_cond'>
                      <p>Justin saw his decision as an easy one and was able to decide quickly. He did not steal the money and instead left the wallet with Customer Service.</p>
                    </div>
                    <div id='m_nate' class='moral_cond'>
                      <p>In contrast, Nate saw his decision as difficult and was only able to decide after long and careful deliberation. After several minutes of thinking in his car, he too decided not to steal the money and instead left the wallet with Customer Service.</p>
                    </div>
                  </div>`
                : `<div id='immoral_trial'>
                    <div id='im_justin' class='immoral_cond'>
                      <p>Justin saw his decision as an easy one and was able to decide quickly. He pocketed the money and drove off.</p>
                    </div>
                    <div id='im_nate' class='immoral_cond'>
                      <p>In contrast, Nate saw his decision as difficult and was only able to decide after long and careful deliberation. After several minutes of thinking in his car, he too decided to pocket the money and drive off.</p>
                    </div>
                  </div>`
            }
            <p>Press any key to continue to the questionnaires.</p>
          </div>
        `,
        on_finish: () => console.log("Trial scenario for", condition, "condition completed")
      };


      // Define the template questions with [name] as a placeholder
      const questionTemplates = [
        "Did [name] make his decision quickly or slowly? (1 = particularly slowly, 7 = particularly quickly)",
        "Regardless of [name]'s decision, does it sound like [name] has underlying moral principles that are good, bad, or somewhere in between? (1 = completely bad, 4 = mixed, 7 = completely good)",
        "Regardless of [name]'s decision, do you think [name] has moral standards that are good, bad, or somewhere in between? (1 = completely bad, 4 = mixed, 7 = completely good)",
        "Regardless of [name]'s decision, do you think [name] possesses the moral knowledge and principles necessary to do 'the right thing'? (1 = not at all, 4 = somewhat, 7 = completely)",
        "Would you say [name] was quite certain in his decision, or did [name] have hesitations about his decision? (1 = completely certain, 7 = considerable hesitations)",
        "How close do you think [name] was to choosing the alternate course of action? (1 = very close to, 7 = not close at all)",
        "How conflicted do you think [name] felt in making the decision? (1 = very conflicted, 7 = not at all conflicted)",
        "Based on the information provided, do you think [name] had many reservations about the decision? (1 = none at all, 7 = a whole lot)",
        "Do you think [name] was calm and emotionally contained while making the decision? (1 = not at all, 7 = entirely so)",
        "To what extent do you think [name] became upset and acted without thinking? (1 = not at all, 7 = entirely so)"
      ];

      // Function to create a questionnaire for a person with consistent Likert scale labels
      function createQuestionnaire(name, condition) {
        const labels = ["1", "2", "3", "4", "5", "6", "7"]; // Uniform labels for all questions

        // Map each question template, replacing [name] with the actual name
        const questions = questionTemplates.map(prompt => ({
          prompt: `<div class="question-container">${prompt.replace(/\[name\]/g, name)}</div>`,
          labels: labels,
          required: true
        }));

        // Customize preamble based on the name and condition
        const preamble = condition === "moral"
          ? `<div id="m_${name.toLowerCase()}" class="moral_cond"><p>${name} saw his decision as ${
              name === "Justin" ? "an easy one and decided quickly, opting to leave the wallet with Customer Service."
                                : "a difficult one, deliberating for a while before deciding to leave the wallet with Customer Service."
            }</p></div>`
          : `<div id="im_${name.toLowerCase()}" class="immoral_cond"><p>${name} saw his decision as ${
              name === "Justin" ? "an easy one, quickly deciding to pocket the money and drive off."
                                : "a difficult one, but after some thought, he also chose to pocket the money and drive off."
            }</p></div>`;

        // Return the questionnaire object with the consistent scale labels
        return {
          type: jsPsychSurveyLikert,
          questions: questions,
          preamble: preamble,
          on_finish: (data) => console.log(`${name}'s questionnaire responses:`, data.response)
        };
      }

      // Create questionnaire objects for Justin and Nate
      const justin_questions = createQuestionnaire("Justin", condition);
      const nate_questions = createQuestionnaire("Nate", condition);

      // Randomize the order of Justin's and Nate's questions
      const randomized_questions = jsPsych.randomization.shuffle([justin_questions, nate_questions]);

      // End message
      const end_message = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: "<p>Thank you for participating in the study!</p><p>Press any key to finish.</p>",
        on_finish: () => console.log("End of experiment")
      };


      // Create the unique filename using a subject ID
      const subject_id = jsPsych.randomization.randomID(10);
      const filename = `${subject_id}.csv`;

      // Save data configuration
      const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "fWVZFOaYbb59", // Replace with your actual experiment ID
        filename: filename,
        data_string: () => jsPsych.data.get().csv()
      };

      // Timeline for the experiment
      const timeline = [consent, instructions, trial_scenario, ...randomized_questions, end_message, save_data];

      // Run the experiment
      console.log("Starting experiment with timeline:", timeline);
      jsPsych.run(timeline);

    });
  </script>
</html>
